<!DOCTYPE html>
<html lang="en">
<head>
	<title>뿡상의 개발공부로그</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="description" content="" />
	<meta name="keywords" content="" />

	<link rel="shortcut icon" href="/images/favicon.ico">

	<link rel="stylesheet" href="/css/style.css" />
	<link rel="stylesheet" href="/css/post.css" />
	<link rel="stylesheet" href="/css/base.css" />

	<link rel="stylesheet" href="/css/etc.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link href='https://cdn.iconmonstr.com/1.2.0/css/iconmonstr-iconic-font.min.css' rel='stylesheet'>
	<!-- font -->
	<link href='https://cdn.rawgit.com/openhiun/hangul/14c0f6faa2941116bb53001d6a7dcd5e82300c3f/nanumbarungothic.css' rel='stylesheet' type='text/css'>
	<link href='https://fonts.googleapis.com/css?family=Architects Daughter' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Bungee Hairline' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Bubbler One' rel='stylesheet'>
	<link href="https://fonts.googleapis.com/css?family=Patrick Hand SC" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.css" rel="stylesheet">
	<!--external css-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- Custom styles for this template -->
	<link href="/css/style-header.css" rel="stylesheet">
	<link href="/css/style-responsive.css" rel="stylesheet">

	
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	  ga('create', UA-100042262-1, 'auto'); // config google_analytics ua에 저장한 추적 ID가 들어감
	    ga('send', 'pageview');
	</script>

	<script src="/dest/jekyll-search.js" type="text/javascript"></script>


<script type="text/javascript">
      SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search.json',
        searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
        noResultsText: 'No results found',
        limit: 10,
        fuzzy: true,
        exclude: ['Welcome']
      })
</script>


</head>

<body>
  <div id="container" class="container">
    
<div id="top-wrap">
  <header id="header" class="header black-bg">
    <!-- Menubar Button -->
    <div class="sidebar-toggle-box">
      <div class="fa fa-bars" data-placement="right"></div>
    </div>
    <!-- Logo -->
    <a href="/" class="front-logo">bbungsang </a>
    <a href="">  </a>
    <a href="/" class="back-logo"> Devlog</a>
    <div class="nav notify-row" id="top_menu">
    </div>
    <div class="top-menu">
    	<ul class="nav pull-right top-menu">
        <li>
          <a class="logout" href="https://github.com/bbungsang">
            <!-- <img src="/images/github.png" width="24px"> -->
            GitHub
          </a>
        </li>
        <li>
          <a class="logout" href="#">
            <!-- <img src="/images/facebook.png" width="24px"> -->
            Facebook
          </a>
        </li>
    	</ul>
    </div>
  </header>

  <!-- **********************************************************************************************************************************************************
  MAIN SIDEBAR MENU
  *********************************************************************************************************************************************************** -->
  <!--sidebar start-->
  <aside>
    <div id="sidebar"  class="nav-collapse">
      <!-- sidebar menu start-->
      <ul class="sidebar-menu" id="nav-accordion">
        <p class="centered"><a href="#"><img src="/images/meme.png" class="img-circle" width="90px"></a></p>
    	  <h5 class="centered">Elena Kim</h5>
        <p class="centered">
          <a href="#" class="contact"><img src="/images/facebook.png" width="20px"></a>
          <a href="https://github.com/bbungsang" class="contact"><img src="/images/github.png" width="20px"></a>
          <a href="#" class="contact"><img src="/images/google.png" width="20px"></a>
        </p>
        <li class="sub-menu">
          <a href="javascript:;" >
            <!-- <span class="glyphicon glyphicon-flash"></span> -->
            <span class="glyphicon glyphicon-plus-sign plus-button pull-right"></span>
            Python
          </a>
          <ul class="sub">
            <li><a href="/files/python/basic.html">문법</a></li>
            <li><a href="/files/python/library.html">라이브러리</a></li>
          </ul>
        </li>

        <li class="sub-menu">
          <a href="javascript:;" >
            <!-- <span class="glyphicon glyphicon-grain"></span> -->
            <span class="glyphicon glyphicon-plus-sign plus-button pull-right"></span>
            Django
          </a>
          <ul class="sub">
            <li><a href="/files/django/djangogirls.html">Do 장고걸스!</a></li>
            <li><a href="/files/django/travel.html">Ask 장고 여행블로그</a></li>
            <!-- <li><a href="/files/django/tutorial.html">장고 튜토리얼</a></li> -->
            <li><a href="/files/django/instargram.html">인스타그램</a></li>
          </ul>
        </li>

        <li class="sub-menu">
          <a href="javascript:;" >
            <!-- <span class="glyphicon glyphicon-tint"></span> -->
            <span class="glyphicon glyphicon-plus-sign plus-button pull-right"></span>
            Algorithm
          </a>
          <ul class="sub">
            <li><a href="/files/algorithm/tryhelloworld.html">Try Hello World</a></li>
          </ul>
        </li>
        <li class="sub-menu">
          <a href="javascript:;" >
            <!-- <span class="glyphicon glyphicon-heart-empty"></span> -->
            <span class="glyphicon glyphicon-plus-sign plus-button pull-right"></span>
            Study
          </a>
          <ul class="sub">
            <li><a href="/files/study/two-scoops.html">두숟갈 스터디</a></li>
            <li><a href="#">DRF</a></li>
          </ul>
        </li>
        <li class="sub-menu">
          <a href="javascript:;" >
            <!-- <span class="glyphicon glyphicon-star"></span> -->
            <span class="glyphicon glyphicon-plus-sign plus-button pull-right"></span>
            etc
          </a>
          <ul class="sub">
            <li><a href="/files/etc/aws.html">AWS</a></li>
            <li><a href="/files/etc/mentoring.html">개발자 멘토링</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </aside>
</div>

<!-- js placed at the end of the document so the pages load faster -->
<script src="/js/jquery.js"></script>
<script src="/js/jquery-1.8.3.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script class="include" type="text/javascript" src="/js/jquery.dcjqaccordion.2.7.js"></script>
<script src="/js/jquery.scrollTo.min.js"></script>

<!--common script for all pages-->
<script src="/js/common-scripts.js"></script>

    <div class="empty"></div>
        <div id="markdown" class="markdown">
    <article class="markdown-body">
      <header class="major">
        <div class="h1">[인스타그램] 로그인 기능 구현하기</div>
        <div class="date-tags">
          16 Jun 2017
          <img src="/images/tags.png" class="tag-img"/>
<div class="post-tags">
  
  
  <a href="/tags/#django">django</a>,
  
  <a href="/tags/#instargram">instargram</a>
  
</div>
<br/>

        </div>
      </header>
      <!-- <hr noshade style="width: 100%; float: left;"> -->
      <section class="post-content">
        <h1 id="로그인-기능-구현하기">로그인 기능 구현하기</h1>
<p>폼 -&gt; 뷰 -&gt; URL -&gt; 템플릿 순서로 구현하려고 한다.</p>

<blockquote>
  <p>고려해야할 부분</p>
  <ol>
    <li>아이디와 비밀번호를 입력할 폼 작성</li>
    <li>POST 요청이 아닐 경우, 빈 로그인 폼을 받아서 로그인 페이지에 넘긴다.</li>
    <li>사용자가 폼을 입력하지 않으면, 입력 요청 메세지를 띄우며 다음 페이지로 이동을 막는다.</li>
    <li>입력한 아이디와 비밀번호가 데이터베이스의 데이터와 일치하지 않을 경우, 에러 메세지를 뿜뿜하며 다음 페이지로 이동을 막고, 일치할 경우, 장고 로그인 메서드를 실행하고 post_list 페이지로 이동.</li>
    <li>이미 로그인한 상태에서 로그인 페이지로 이동한 것이라면 post_list 페이지로 되돌린다.</li>
  </ol>
</blockquote>

<h3 id="1-장고-폼에서-위젯을-생성하고-데이터-유효성-및-하자-여부-검사하기">1. 장고 폼에서 위젯을 생성하고, 데이터 유효성 및 하자 여부 검사하기</h3>
<ul>
  <li>LoginForm, SignupForm과 앞으로 더 필요할 수 있는 폼들을 파이썬 패키지를 생성하여 하위 항목으로 둔다. 왜? 하나의 파일에 모든 폼 클래스를 작성하면, 코드가 길어져서 보기에 불편함을 겪을 수 있기 때문이다.</li>
  <li>member 앱 디렉토리에 forms 패키지를 생성하고 login.py를 생성하여 아래와 같이 작성한다.</li>
</ul>

<p>[forms/login.py] : 폼 위젯 만들기</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="k">class</span> <span class="nc">LoginForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>

  <span class="c"># 문자열을 받는 폼 필드에 최대 길이 30자, 문자열을 받는 위젯의 속성을 포함하여 username 에 할당</span>
  <span class="c"># 즉, username 이 곧 하나의 필드가 된다.</span>
  <span class="n">username</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
    <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">TextInput</span><span class="p">(</span>
      <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'placeholder'</span><span class="p">:</span> <span class="s">'아이디를 입력해주세요.'</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="p">)</span> <span class="c"># 이 괄호 끝에 튜플이나 딕셔너리처럼 습관적으로 ','을 넣었었는데, 그 뒤 password 필드를 무시하게 되는 일이 발생했었다.</span>

  <span class="c"># username 과 같이 입력 받을 password 필드 정의, 위젯의 경우, 패스워드는 문자열이 드러나면 곤란하기 때문에 forms.PasswordInput() 을 통해 문자열을 가려준다.</span>
  <span class="n">password</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
      <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">(</span>
          <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
              <span class="s">'placeholder'</span><span class="p">:</span> <span class="s">'비밀번호를 입력해주세요.'</span>
          <span class="p">}</span>
      <span class="p">)</span>
    <span class="p">)</span>
</code></pre>
</div>

<h4 id="장고가-제공하는-유효성-검사기">장고가 제공하는 유효성 검사기</h4>
<ul>
  <li>clean() 메서드는 단일 인수를 사용하여 잘못된 입력에 대해 ValidationError를 발생시키는 간단한 함수이다.</li>
  <li>일반적으로 <code class="highlighter-rouge">is_valid()</code> 를 호출할 때 실행되고, <code class="highlighter-rouge">cleaned_data</code> 에 딕셔너리 { ‘html-form-name’: ‘html-form-value’ } 의 형태로 할당된다.</li>
  <li>양식을 처리하면서 세 가지 유형 to_python(), validate(), run_validators() 을 순차적으로 실행한다.</li>
  <li>처리 중인 데이터에 문제가 있으면 ValidationError 생성자에 관련 정보를 전달하여 클리닝 메서드가 ValidationError 를 발생시킨다.</li>
  <li>
    <p>ValidationError 가 발생하지 않으면 정리된 데이터를 파이썬 객체로 반환해야 한다.</p>
  </li>
  <li><strong>clean() 메서드</strong>
    <ul>
      <li>to_python(), validate(), run_validators() 를 올바른 순서로 실행하고 오류 전파</li>
      <li>ValidationError를 발생시키는 메서드가 있으면 유효성 검사가 중지되고 해당 오류가 발생, 깨끗한 데이터를 반환한 다음 폼의 cleaned_data 사전에 삽입</li>
      <li>self.cleaned_data에서 필드 값을 찾고 이 시점에 파이썬 객체가 된다.</li>
    </ul>
  </li>
  <li><strong>authenticate() 메서드</strong>
    <ul>
      <li>자격 증명이 유효한 경우, User 객체를 반환, 유효하지 않으면 None을 반환한다.</li>
      <li>request 는 authenticate() 를 통과한 옵션 HttpRequest 다.</li>
    </ul>
  </li>
  <li>authenticate() 를 통해 인증에 성공하면, cleaned_data 에 ‘user’ 를 키값으로 User 객체를 할당한다.</li>
</ul>

<p>[forms/login.py] : 데이터 유효성 및 하자 여부 검사하기</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#...</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">authenticate</span>

<span class="c">#...</span>
<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c"># is_valid() 가 실행되면서 사용자로 부터 폼에서 입력 받은 {'username': '사용자가 입력한 값', 'password': '사용자가 입력한 값'}이 cleaned_data 사전에 삽입될 것이다.</span>
    <span class="c"># cleaned_data 사전으로 부터 username 과 password key 의 value 를 각각의 변수에 할당한다.  </span>
    <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"username"</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"password"</span><span class="p">)</span>

    <span class="c"># value 가 유효하면 User 객체를 user 에 할당하고 유효하지 않으면 None 이 할당된다.</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c"># None 이 아니면(무효하지 않으면), cleaned_data 사전에 'user' 를 key 로 User 객체를 value 로 삽입한다.</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'user'</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">'Login credentials not valid!'</span>
        <span class="p">)</span>

    <span class="c"># {'username': '사용자가 입력한 값', 'password': '사용자가 입력한 값', 'user': User 객체} 를 반환한다.    </span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span>
</code></pre>
</div>

<h3 id="2-post-요청이-아닐-경우-빈-로그인-폼을-받아서-로그인-페이지로-넘기기">2. POST 요청이 아닐 경우, 빈 로그인 폼을 받아서 로그인 페이지로 넘기기</h3>
<ul>
  <li>이 부분은 뷰가 처리한다.</li>
</ul>

<p>[member/views.py] 에서 로그인을 위해 사용된 모듈</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">member.forms.login</span> <span class="kn">import</span> <span class="n">LoginForm</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">login</span> <span class="k">as</span> <span class="n">django_login</span><span class="p">,</span> <span class="n">logout</span> <span class="k">as</span> <span class="n">django_logout</span><span class="p">,</span>
</code></pre>
</div>

<p>[member/views.py]</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
    <span class="k">pass</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'form'</span><span class="p">:</span> <span class="n">form</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'member/login.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="3-사용자가-폼을-입력하지-않으면-입력-요청-메세지를-띄우며-다음-페이지-이동-막기">3. 사용자가 폼을 입력하지 않으면, 입력 요청 메세지를 띄우며 다음 페이지 이동 막기</h3>
<ul>
  <li>이 부분은 장고에서 알아서 해준다. 친절한 장고씨♡</li>
</ul>

<h3 id="4-입력한-아이디와-비밀번호가-데이터베이스-데이터와-일치하지-않으면-에러-메세지-뿜뿜-하지만-일치하면-로그인-하기">4. 입력한 아이디와 비밀번호가 데이터베이스 데이터와 일치하지 않으면, 에러 메세지 뿜뿜! 하지만 일치하면, 로그인 하기</h3>
<ul>
  <li>뷰에서 is_valid() 가 실행되면서 폼의 authenticate() 를 통해 데이터가 일치하면 User 객체를, 데이터가 없거나 일치하지 않으면 None 을 반환한다.</li>
  <li>None 일 경우 ‘Login credentials not valid!’ 메세지를 띄우며 에러를 일으킨다.</li>
</ul>

<p>[member/views.py]</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">post</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>

      <span class="c"># User 객체를 얻어서</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'user'</span><span class="p">]</span>

      <span class="c"># 장고 로그인 메서드의 인자로 전달하여 로그인을 실행한다.</span>
      <span class="n">django_login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'post:post_list'</span><span class="p">)</span>
    <span class="c">#...</span>
</code></pre>
</div>

<h3 id="5-이미-로그인한-상태에서-로그인-페이지로-이동한-것이라면-post_list-페이지로-튕겨내기">5. 이미 로그인한 상태에서 로그인 페이지로 이동한 것이라면 post_list 페이지로 튕겨내기</h3>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
  <span class="n">form</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">LoginForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">post</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
    <span class="c">#...</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
      <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'post:post_list'</span><span class="p">)</span>
    <span class="c">#...</span>
</code></pre>
</div>

      </section>
      <br><br>
      <footer>
        
        <a href="/%EC%9D%B8%EC%8A%A4%ED%83%80%EA%B7%B8%EB%9E%A8/instargram/2017/06/15/instargram-postapp-view-url-template(2).html" class="float-left">&larr; Previous post</a> 
        
        <a href="/solve%20algorithm!/algorithm/2017/06/19/tryhelloworld-level2-1.html" class="float-right">Next post &rarr;</a> 
        <br><br>
        
  <div id="disqus_thread"></div>
  <script>

  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://https-bbungsang-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


      </footer>
    </article>
  </div>

  </div>
</body>
</html>
